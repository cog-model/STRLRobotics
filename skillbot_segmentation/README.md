# Referring Segmentation pipeline

## Description
This repository contains the necessary code to run ROS nodes for the OpenSeeD text query segmentation module. In particular, there are nodes for:

- publication of a list of categories and their numbers from the LLM plan
- OpenSeeD segmentation


## Installation

- Create a conda environment
```bash
conda create --name openseed python=3.8 -y
conda activate openseed
```
- Install packages and other dependencies.
```bash
pip3 install torch==1.13.1 torchvision==0.14.1 --extra-index-url https://download.pytorch.org/whl/cu113
python -m pip install 'git+https://github.com/MaureenZOU/detectron2-xyz.git'
pip install git+https://github.com/cocodataset/panopticapi.git
python -m pip install -r requirements.txt
pip install albumentations
pip install Pillow==9.5.0 
pip install wandb
git clone https://github.com/andrey1908/kas_utils.git
cd kas_utils/python
pip install .
```

- Compile custom CUDA kernels:

```bash
cd skillbot_segmentation/src/openseed_src/openseed/body/encoder/ops
sh make.sh
cd skillbot_segmentation/
```

- Install [rospkg](https://anaconda.org/conda-forge/rospkg) to use ROS inside the conda environment
```bash
conda install -c conda-forge rospkg
```

- Build working space:

```bash
catkin_make --cmake-args \
            -DCMAKE_BUILD_TYPE=Release \
            -DPYTHON_EXECUTABLE=/usr/bin/python3.8 \
            -DPYTHON_INCLUDE_DIR=/usr/include/python3.8m \
            -DPYTHON_LIBRARY=/usr/lib/x86_64-linux-gnu/libpython3.8m.so
```

- Download the weights of the OpenSeeD model. Link to folder with model weights: [https://disk.yandex.ru/d/SnmwjHCEtSuLzA](https://disk.yandex.ru/d/SnmwjHCEtSuLzA).

model_0003599_demo.pth - Ð²weights of the OpenSeeD model, retrained without frozen layers sequentially on datasets  $LLMObjectSorter_{train} v0$, $LLMObjectSorter_{train} v2$ without data augmentations.

model_full_aug.pth - weights of the OpenSeeD model, retrained with a frozen text encoder and backbone, on $LLMObjectSorter_{train} v3$ data sets with additional augmentations.

For more info see [openseed-src](skillbot_segmentation/src/openseed_src).

- Change the path to the model weghts and the configuration file  [skillbot_segmentation/src/husky_tidy_bot_cv/scripts/openseed_node.py](skillbot_segmentation/src/husky_tidy_bot_cv/scripts/openseed_node.py)

- Change the path to the OpenSeeD source code inside the OpenSeeD module: [skillbot_segmentation/src/husky_tidy_bot_cv/scripts/openseed_model.py](skillbot_segmentation/src/husky_tidy_bot_cv/scripts/openseed_model.py)

## Usage

Nodes use information published in each other's topics. Before using node you need to make ```source devel/setup.bash``` from your workspace folder, e.g.
```bash
cd ~/zemskova_ts/ref_seg_ws
source devel/setup.bash
```

1. Publishing a list of categories with their ids from the LLM plan

```
python3 text_query_generation_server.py
```

Object categories are published after the OpenSeeDSetter action from the behavior tree is executed. When first launched, the OpenSeeD node works with the fixed categories ROSBAG_CATEGORIES below (when the server is running text_query_generation_server.py) After which a message like this is published in the topic /segmentation_labels:

int32[] classes_ids
string[] labels # names with features
string[] labels_only_cats # names without features

Classes ids are in the same order as their corresponding labels (and labels_only_cats). Please note that the classes ids are not ordered.

To emulate sending messages from behavior tree, you can use it by changing object and location in the text_query_generation_client.py file.

```bash
python3 text_query_generation_client.py
```

By default, when OpenSeed node starts, it segments known categories from fixed_categories.py and does not publish anything in the topic /segmentation_labels.

New categories are added to the end of the fixed list, which remains unchanged throughout the program. The unspecified category is not added to the list of categories to be recognized. If there is an "orange cube" in the LLM plan, then this will be considered as a new category.
**Logic of adding new categories during segmentation**

New categories are added to the end of the fixed list, which remains unchanged throughout the program. The category ```unspecified``` is not added to the list of categories for recognition. If the LLM plan contains ```orange cube```, then it will be considered as a new category.

**Preprocessing of text queries.**

The \textit{"objects"} query (and only it) adds all objects from a fixed list to the list of objects for segmentation.

Each task in the plan generated by LLM consists of the fields type (type), object (object), location (location). The list of text queries is generated based on the list of categories in the object and location fields for the entire list of tasks from the LLM plan. For some location types, the task text is preprocessed so that pipeline elements working with fixed location names can work.

In particular, if location consists of one of four words: "box", "bin", "container", "basket", then the name of location in the plan is replaced by the name of the container in the list of fixed categories, and if location consists of one of the words , denoting a nightstand in English ("nightstand", "bedside table", "cabinet", "basket", "bedside-table"), then it is replaced by the name of the nightstand in the list of fixed categories. If the location list contains a word denoting a container, then an attempt is made to assign the name of this category to the categories of known container locations based on the proximity of the text embeddings to the categories of known container locations (for example, "red box" -> "orange box"). If the location category name does not match any of the known location positions, then the server returns a FAILED state to the behavior tree.

TextGenerationServer publishes information about the location status in the ROS topic ```location_status```. If the category name location is successfully found in the list of known locations, the message "OK!" is published; if the object is not in the list of known locations, the message "Failed to find a location in LLM plan!" is published.

2. OpenSeeD Segmentation

Check that ```text_query_generation.py``` has been launched and ```/segmentation_labels``` is being published.

In another terminal window:
```bash
python3 openseed_node.py -vis
```

```Classes_ids``` are in the same order as their corresponding ```labels``` (and ```labels_only_cats```). Note that the ```classes_ids``` are not in order.

To emulate sending messages from a behavior tree, you can use it by changing ```object``` and ```location``` in the ```text_query_generation_client.py``` file.

```bash
python3 text_query_generation_client.py
```

-vis - for visualization, you can run without it

The segmentation visualization will be published in the ROS topic ```/segmentation_vis```.
In the ROS topic ```/segmentation``` messages ```Objects.msg``` are published like:

```bash
Header header

int32 num

float64[] scores
int32[] classes_ids
int32[] tracking_ids
Box[] boxes
Mask[] masks
```